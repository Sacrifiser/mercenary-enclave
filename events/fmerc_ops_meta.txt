namespace = fmerc_ops_meta

# Triggered from mission setup effects, after the delay
country_event = {
	id = fmerc_ops_meta.1
	hide_window = yes
	is_triggered_only = yes

	# We should start the mission immediately, the delay has passed.
	immediate = {
		fmerc_init_stage2 = yes
	}
}

# The mercenary operations are complete!
country_event = {
	id = fmerc_ops_meta.911
	hide_window = yes

	mean_time_to_happen = {
		days = 14
	}

	trigger = {
		is_country_type = "fmerc_operations"
		OR = {
			has_country_flag = "fmerc_ops_completed"
			NOT = {
				has_country_flag = "fmerc_ops_timeout"
			}
		}
	}

	immediate = {
		log = "fmerc_ops_meta.911: Terminating mission."

		fmerc_set_buyer = yes
		fmerc_set_target_country = yes
		if = {
			limit = {
				exists = event_target:fmerc_target_country
				event_target:fmerc_target_country = {
					has_country_flag = "fmerc_operations_target"
				}
			}
			log = "Clearing fmerc_target flags from [fmerc_target_country.GetName]'s ships and/or planets, if any."
			event_target:fmerc_target_country = {
				remove_country_flag = "fmerc_operations_target"
				every_owned_ship = {
					limit = { has_ship_flag = "fmerc_target" }
					remove_ship_flag = "fmerc_target"
				}
				every_owned_planet = {
					limit = { has_planet_flag = "fmerc_target" }
					remove_planet_flag = "fmerc_target"
				}
			}
		}

		# If we were doing a clear operation, calculate the cost
		if = {
			limit = {
				exists = event_target:fmerc_buyer
				NOT = { has_country_flag = "fmerc_calculated_costs" }
				OR = {
					has_country_flag = "fmerc_amoeba"
					has_country_flag = "fmerc_cloud"
					has_country_flag = "fmerc_crystal"
					has_country_flag = "fmerc_pirate"
					has_country_flag = "fmerc_drone"
				}
			}
			set_country_flag = "fmerc_calculated_costs"
			if = {
				limit = {
					exists = event_target:fmerc_target_country
					num_killed_ships = {
						target = event_target:fmerc_target_country
						value > 4
					}
				}
				event_target:fmerc_buyer = {
					set_variable = {
						which = MercCost
						value = 3000
					}
				}
				else = { if = {
				limit = {
					exists = event_target:fmerc_target_country
					num_killed_ships = {
						target = event_target:fmerc_target_country
						value > 3
					}
				}
				event_target:fmerc_buyer = {
					set_variable = {
						which = MercCost
						value = 2400
					}
				}
				else = { if = {
				limit = {
					exists = event_target:fmerc_target_country
					num_killed_ships = {
						target = event_target:fmerc_target_country
						value > 2
					}
				}
				event_target:fmerc_buyer = {
					set_variable = {
						which = MercCost
						value = 1800
					}
				}
				else = { if = {
				limit = {
					exists = event_target:fmerc_target_country
					num_killed_ships = {
						target = event_target:fmerc_target_country
						value > 1
					}
				}
				event_target:fmerc_buyer = {
					set_variable = {
						which = MercCost
						value = 1200
					}
				}
				else = { if = {
				limit = {
					exists = event_target:fmerc_target_country
					num_killed_ships = {
						target = event_target:fmerc_target_country
						value > 0
					}
				}
				event_target:fmerc_buyer = {
					set_variable = {
						which = MercCost
						value = 600
					}
				}
				else = {
					event_target:fmerc_buyer = {
						set_variable = {
							which = MercCost
							value = 300
						}
					}
				}
			} } } } } } } } }
			event_target:fmerc_buyer = {
				log = "Clear: Calculated cost is [this.MercCost]."
				fmerc_count_minerals = yes
				fmerc_grabdatcash = yes
			}
		}

		fmerc_stage3_ensure_spawn_location = yes

		if = {
			limit = {
				count_owned_ships { count > 0 }
				exists = event_target:fmerc_spawn_at
			}
			log = "Returning mercenary operations fleet to enclave."
			set_faction_hostility = { set_hostile = no }
			every_owned_fleet = {
				queue_actions = {
					repeat = {
						while = {
							id = fmerc_ops_fleet.911.trigger.1
							NOR = {
								exists = solar_system
								solar_system = {
									is_same_value = event_target:fmerc_spawn_at.solar_system
								}
							}
						}
						move_to = event_target:fmerc_spawn_at.solar_system
						wait = 7
					}
					move_to = event_target:fmerc_spawn_at
					wait = 14
					effect = {
						id = fmerc_ops_fleet.911.effect.1
						remove_fleet_flag = "fmerc_count_towards_success"
						destroy_fleet = THIS
					}
				}
			}
			else = {
				log = "Mercenary operation complete, destroying operation country and resetting buyer."
				event_target:fmerc_buyer = {
					remove_country_flag = "fmerc_active_operation"
					remove_country_flag = "fmerc_calculated_costs"
					country_event = {
						id = fmercdiplo.9004
					}
				}

				fmerc_detection = yes
				destroy_country = yes
			}
		}
	}
}
