

# STAGE 3
# - Operation is ongoing
# - ROOT/THIS can be anything, depending on the effect
# - Effects can be used by any operation


# XXX I'm not actually certain that fleet_size works.
# XXX need to investigate, and potentially use fleet_power instead if possible.
# XXX the alternative is count_fleet_ships

fmerc_get_fleet_size = {
	switch = {
		trigger = fleet_size
		5000 > { ROOT = { set_variable = { which = MercTempSize value = 5000}}}
		4960 > { ROOT = { set_variable = { which = MercTempSize value = 4960}}}
		4920 > { ROOT = { set_variable = { which = MercTempSize value = 4920}}}
		4880 > { ROOT = { set_variable = { which = MercTempSize value = 4880}}}
		4840 > { ROOT = { set_variable = { which = MercTempSize value = 4840}}}
		4800 > { ROOT = { set_variable = { which = MercTempSize value = 4800}}}
		4760 > { ROOT = { set_variable = { which = MercTempSize value = 4760}}}
		4720 > { ROOT = { set_variable = { which = MercTempSize value = 4720}}}
		4680 > { ROOT = { set_variable = { which = MercTempSize value = 4680}}}
		4640 > { ROOT = { set_variable = { which = MercTempSize value = 4640}}}
		4600 > { ROOT = { set_variable = { which = MercTempSize value = 4600}}}
		4560 > { ROOT = { set_variable = { which = MercTempSize value = 4560}}}
		4520 > { ROOT = { set_variable = { which = MercTempSize value = 4520}}}
		4480 > { ROOT = { set_variable = { which = MercTempSize value = 4480}}}
		4440 > { ROOT = { set_variable = { which = MercTempSize value = 4440}}}
		4400 > { ROOT = { set_variable = { which = MercTempSize value = 4400}}}
		4360 > { ROOT = { set_variable = { which = MercTempSize value = 4360}}}
		4320 > { ROOT = { set_variable = { which = MercTempSize value = 4320}}}
		4280 > { ROOT = { set_variable = { which = MercTempSize value = 4280}}}
		4240 > { ROOT = { set_variable = { which = MercTempSize value = 4240}}}
		4200 > { ROOT = { set_variable = { which = MercTempSize value = 4200}}}
		4160 > { ROOT = { set_variable = { which = MercTempSize value = 4160}}}
		4120 > { ROOT = { set_variable = { which = MercTempSize value = 4120}}}
		4080 > { ROOT = { set_variable = { which = MercTempSize value = 4080}}}
		4040 > { ROOT = { set_variable = { which = MercTempSize value = 4040}}}
		4000 > { ROOT = { set_variable = { which = MercTempSize value = 4000}}}
		3960 > { ROOT = { set_variable = { which = MercTempSize value = 3960}}}
		3920 > { ROOT = { set_variable = { which = MercTempSize value = 3920}}}
		3880 > { ROOT = { set_variable = { which = MercTempSize value = 3880}}}
		3840 > { ROOT = { set_variable = { which = MercTempSize value = 3840}}}
		3800 > { ROOT = { set_variable = { which = MercTempSize value = 3800}}}
		3760 > { ROOT = { set_variable = { which = MercTempSize value = 3760}}}
		3720 > { ROOT = { set_variable = { which = MercTempSize value = 3720}}}
		3680 > { ROOT = { set_variable = { which = MercTempSize value = 3680}}}
		3640 > { ROOT = { set_variable = { which = MercTempSize value = 3640}}}
		3600 > { ROOT = { set_variable = { which = MercTempSize value = 3600}}}
		3560 > { ROOT = { set_variable = { which = MercTempSize value = 3560}}}
		3520 > { ROOT = { set_variable = { which = MercTempSize value = 3520}}}
		3480 > { ROOT = { set_variable = { which = MercTempSize value = 3480}}}
		3440 > { ROOT = { set_variable = { which = MercTempSize value = 3440}}}
		3400 > { ROOT = { set_variable = { which = MercTempSize value = 3400}}}
		3360 > { ROOT = { set_variable = { which = MercTempSize value = 3360}}}
		3320 > { ROOT = { set_variable = { which = MercTempSize value = 3320}}}
		3280 > { ROOT = { set_variable = { which = MercTempSize value = 3280}}}
		3240 > { ROOT = { set_variable = { which = MercTempSize value = 3240}}}
		3200 > { ROOT = { set_variable = { which = MercTempSize value = 3200}}}
		3160 > { ROOT = { set_variable = { which = MercTempSize value = 3160}}}
		3120 > { ROOT = { set_variable = { which = MercTempSize value = 3120}}}
		3080 > { ROOT = { set_variable = { which = MercTempSize value = 3080}}}
		3040 > { ROOT = { set_variable = { which = MercTempSize value = 3040}}}
		3000 > { ROOT = { set_variable = { which = MercTempSize value = 3000}}}
		2960 > { ROOT = { set_variable = { which = MercTempSize value = 2960}}}
		2920 > { ROOT = { set_variable = { which = MercTempSize value = 2920}}}
		2880 > { ROOT = { set_variable = { which = MercTempSize value = 2880}}}
		2840 > { ROOT = { set_variable = { which = MercTempSize value = 2840}}}
		2800 > { ROOT = { set_variable = { which = MercTempSize value = 2800}}}
		2760 > { ROOT = { set_variable = { which = MercTempSize value = 2760}}}
		2720 > { ROOT = { set_variable = { which = MercTempSize value = 2720}}}
		2680 > { ROOT = { set_variable = { which = MercTempSize value = 2680}}}
		2640 > { ROOT = { set_variable = { which = MercTempSize value = 2640}}}
		2600 > { ROOT = { set_variable = { which = MercTempSize value = 2600}}}
		2560 > { ROOT = { set_variable = { which = MercTempSize value = 2560}}}
		2520 > { ROOT = { set_variable = { which = MercTempSize value = 2520}}}
		2480 > { ROOT = { set_variable = { which = MercTempSize value = 2480}}}
		2440 > { ROOT = { set_variable = { which = MercTempSize value = 2440}}}
		2400 > { ROOT = { set_variable = { which = MercTempSize value = 2400}}}
		2360 > { ROOT = { set_variable = { which = MercTempSize value = 2360}}}
		2320 > { ROOT = { set_variable = { which = MercTempSize value = 2320}}}
		2280 > { ROOT = { set_variable = { which = MercTempSize value = 2280}}}
		2240 > { ROOT = { set_variable = { which = MercTempSize value = 2240}}}
		2200 > { ROOT = { set_variable = { which = MercTempSize value = 2200}}}
		2160 > { ROOT = { set_variable = { which = MercTempSize value = 2160}}}
		2120 > { ROOT = { set_variable = { which = MercTempSize value = 2120}}}
		2080 > { ROOT = { set_variable = { which = MercTempSize value = 2080}}}
		2040 > { ROOT = { set_variable = { which = MercTempSize value = 2040}}}
		2000 > { ROOT = { set_variable = { which = MercTempSize value = 2000}}}
		1960 > { ROOT = { set_variable = { which = MercTempSize value = 1960}}}
		1920 > { ROOT = { set_variable = { which = MercTempSize value = 1920}}}
		1880 > { ROOT = { set_variable = { which = MercTempSize value = 1880}}}
		1840 > { ROOT = { set_variable = { which = MercTempSize value = 1840}}}
		1800 > { ROOT = { set_variable = { which = MercTempSize value = 1800}}}
		1760 > { ROOT = { set_variable = { which = MercTempSize value = 1760}}}
		1720 > { ROOT = { set_variable = { which = MercTempSize value = 1720}}}
		1680 > { ROOT = { set_variable = { which = MercTempSize value = 1680}}}
		1640 > { ROOT = { set_variable = { which = MercTempSize value = 1640}}}
		1600 > { ROOT = { set_variable = { which = MercTempSize value = 1600}}}
		1560 > { ROOT = { set_variable = { which = MercTempSize value = 1560}}}
		1520 > { ROOT = { set_variable = { which = MercTempSize value = 1520}}}
		1480 > { ROOT = { set_variable = { which = MercTempSize value = 1480}}}
		1440 > { ROOT = { set_variable = { which = MercTempSize value = 1440}}}
		1400 > { ROOT = { set_variable = { which = MercTempSize value = 1400}}}
		1360 > { ROOT = { set_variable = { which = MercTempSize value = 1360}}}
		1320 > { ROOT = { set_variable = { which = MercTempSize value = 1320}}}
		1280 > { ROOT = { set_variable = { which = MercTempSize value = 1280}}}
		1240 > { ROOT = { set_variable = { which = MercTempSize value = 1240}}}
		1200 > { ROOT = { set_variable = { which = MercTempSize value = 1200}}}
		1160 > { ROOT = { set_variable = { which = MercTempSize value = 1160}}}
		1120 > { ROOT = { set_variable = { which = MercTempSize value = 1120}}}
		1080 > { ROOT = { set_variable = { which = MercTempSize value = 1080}}}
		1040 > { ROOT = { set_variable = { which = MercTempSize value = 1040}}}
		1000 > { ROOT = { set_variable = { which = MercTempSize value = 1000}}}
		960 > { ROOT = { set_variable = { which = MercTempSize value = 960}}}
		920 > { ROOT = { set_variable = { which = MercTempSize value = 920}}}
		880 > { ROOT = { set_variable = { which = MercTempSize value = 880}}}
		840 > { ROOT = { set_variable = { which = MercTempSize value = 840}}}
		800 > { ROOT = { set_variable = { which = MercTempSize value = 800}}}
		760 > { ROOT = { set_variable = { which = MercTempSize value = 760}}}
		720 > { ROOT = { set_variable = { which = MercTempSize value = 720}}}
		680 > { ROOT = { set_variable = { which = MercTempSize value = 680}}}
		640 > { ROOT = { set_variable = { which = MercTempSize value = 640}}}
		600 > { ROOT = { set_variable = { which = MercTempSize value = 600}}}
		560 > { ROOT = { set_variable = { which = MercTempSize value = 560}}}
		520 > { ROOT = { set_variable = { which = MercTempSize value = 520}}}
		480 > { ROOT = { set_variable = { which = MercTempSize value = 480}}}
		440 > { ROOT = { set_variable = { which = MercTempSize value = 440}}}
		400 > { ROOT = { set_variable = { which = MercTempSize value = 400}}}
		360 > { ROOT = { set_variable = { which = MercTempSize value = 360}}}
		320 > { ROOT = { set_variable = { which = MercTempSize value = 320}}}
		280 > { ROOT = { set_variable = { which = MercTempSize value = 280}}}
		240 > { ROOT = { set_variable = { which = MercTempSize value = 240}}}
		200 > { ROOT = { set_variable = { which = MercTempSize value = 200}}}
		160 > { ROOT = { set_variable = { which = MercTempSize value = 160}}}
		120 > { ROOT = { set_variable = { which = MercTempSize value = 120}}}
		80 > { ROOT = { set_variable = { which = MercTempSize value = 80}}}
		60 > { ROOT = { set_variable = { which = MercTempSize value = 70}}}
		50 > { ROOT = { set_variable = { which = MercTempSize value = 60}}}
		40 > { ROOT = { set_variable = { which = MercTempSize value = 50}}}
		30 > { ROOT = { set_variable = { which = MercTempSize value = 40}}}
		20 > { ROOT = { set_variable = { which = MercTempSize value = 30}}}
		0 > { ROOT = { set_variable = { which = MercTempSize value = 20}}}
	}
}


fmerc_match_variable = {
	ROOT = {
		# ZZZ remember that while loops only loop to 100
		while = {
			limit = {
				check_variable = {
					which = MercTempSize
					value > 4
				}
			}
			last_created_fleet = {
				create_ship = {
					name = random
					random_existing_design = nongfx_fmerc_ship_01
					prefix = no
				}
				create_ship = {
					name = random
					random_existing_design = nongfx_fmerc_ship_01
					prefix = no
				}
				create_ship = {
					name = random
					random_existing_design = nongfx_fmerc_ship_01
					prefix = no
				}
				create_ship = {
					name = random
					random_existing_design = nongfx_fmerc_ship_01
					prefix = no
				}
			}
			change_variable = {
				which = MercTempSize
				value = -16
			}
		}
	}
}

# requires event_target:fmerc_target_country
fmerc_stage3_ensure_spawn_location = {
	# even though the trigger_docs say "Supported Scopes: all",
	# closest_system does in fact not support the country scope.
	event_target:fmerc_target_country = {
		capital_scope = {
			closest_system = {
				limit = {
					any_ship_in_system = {
						is_in_combat = no
						exists = owner
						owner = {
							is_country_type = "fmerc_enclave"
						}
					}
					# If we can, try to spawn inside the targets borders.
					# This gives the "Allow border access" enclave option some
					# real value.
					OR = {
						NOT = {
							exists = space_owner
						}
						AND = {
							exists = space_owner
							exists = event_target:fmerc_target_country
							space_owner = { is_same_value = event_target:fmerc_target_country }
						}
					}
				}
				#min_steps = 1
				random_fleet_in_system = {
					limit = {
						is_in_combat = no
						exists = owner
						owner = {
							is_country_type = "fmerc_enclave"
						}
					}
					save_event_target_as = fmerc_spawn_location
				}
			}
		}
	}
	if = {
		limit = { NOT = { exists = event_target:fmerc_spawn_location } }
		random_country = {
			limit = { is_country_type = "fmerc_enclave" }
			random_owned_fleet = {
				save_event_target_as = fmerc_spawn_location
			}
		}
	}
	if = {
		limit = { NOT = { exists = event_target:fmerc_spawn_location } }
		log = "Stage 3: Unable to find spawn location, aborting mission."
		set_country_flag = "fmerc_ops_completed"
		break = yes
	}
}

fmerc_stage3_create_fleet = {
	# Make sure we have somewhere to spawn
	fmerc_stage3_ensure_spawn_location = yes

	log = "Creating new fleet in [fmerc_spawn_location.GetStarName]."

	# For when we recreate the fleet
	set_faction_hostility = { set_hostile = no }
	create_fleet = {
		effect = {
			set_owner = ROOT
			set_location = {
				target = event_target:fmerc_spawn_location
				distance = 40
				angle = random
			}
			create_ship = {
				name = random
				random_existing_design = nongfx_fmerc_ship_01
				prefix = no
			}
			set_formation_scale = 1.8
			set_fleet_stance = passive
			set_aggro_range_measure_from = self
			set_aggro_range = 80
			# This exists in the game, but apparently it's not exposed.
			#set_fleet_ground_support_stance_command = ..
		}
	}
	# fmerc_target is always a planet or fleet
	event_target:fmerc_target = {
		solar_system = {
			every_fleet_in_system = {
				limit = {
					exists = owner
					owner = {
						is_same_value = event_target:fmerc_target_country
					}
				}
				fmerc_get_fleet_size = yes
				fmerc_match_variable = yes
			}
		}
	}
	last_created_fleet = {
		if = {
			limit = {
				fleet_size < 20
			}
			while = {
				count = 5
				create_ship = {
					name = random
					random_existing_design = nongfx_fmerc_ship_01
					prefix = no
				}
			}
		}
	}
	if = {
		limit = { has_country_flag = "fmerc_liberate" }
		last_created_fleet = {
			while = {
				count = 5
				create_ship = {
					name = random
					random_existing_design = nongfx_fmerc_ship_01
					prefix = no
				}
			}
		}
	}
	if = {
		limit = {
			exists = event_target:fmerc_target_country
			NOT = { event_target:fmerc_target_country = { is_country_type = "default" } }
		}
		last_created_fleet = {
			while = {
				count = 10
				create_ship = {
					name = random
					random_existing_design = nongfx_fmerc_ship_01
					prefix = no
				}
			}
		}
	}
}
