###
# This file is part of a project hosted at https://github.com/stellaris-mods
# Copyright (c) 2017 folk@folk.wtf
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software Foundation,
# Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301  USA
###


# Stage 4 = operation is complete, or abort

merc_stage4_additional_costs = {
	switch = {
		trigger = has_country_flag
		merc_op_clear = { merc_stage4_additional_costs_clear = yes }
	}
}

merc_stage4_destroy = {
	log = "Shutting down."
	merc_stage4_additional_costs = yes
	merc_set_buyer = yes
	merc_set_country = yes

	if = {
		limit = { merc_is_country_target_valid = yes }
		event_target:merc_country = {
			remove_country_flag = "fmerc_operations_target"
			every_owned_ship = {
				limit = { has_ship_flag = "merc_target" }
				remove_ship_flag = "merc_target"
			}
			every_owned_planet = {
				limit = { has_planet_flag = "merc_target" }
				remove_planet_flag = "merc_target"
			}
		}
	}

	every_owned_fleet = {
		clear_fleet_actions = this
		delete_fleet = this
	}

	event_target:merc_buyer = {
		remove_country_flag = "fmerc_active_operation"
		remove_country_flag = "fmerc_calculated_costs"
		country_event = {
			id = mercMenu.9004
		}
	}

	merc_check_detection = yes
	destroy_country = yes
}


# All effects below check this first
merc_stage4_verify_operation_ongoing = {
	if = { limit = { has_country_flag = "merc_op_dock" }
		merc_stage4_destroy = yes
		break = yes
	}
}

merc_stage4_complete = {
	merc_stage4_verify_operation_ongoing = yes
	log = "Operation complete."

	set_faction_hostility = { set_hostile = no }

	merc_set_buyer = yes
	merc_set_country = yes
	merc_ensure_harbor = yes

	if = {
		limit = { count_owned_ships { count > 0 } }
		event_target:merc_harbor = { save_event_target_as = merc_current_target }
		log = "Returning mercenary fleets to dock ..."
		set_country_flag = "merc_op_dock"
		every_owned_fleet = {
			clear_fleet_actions = this
			fleet_event = { id = mercControllerFleet.100 }
		}

		else = {
			merc_stage4_destroy = yes
		}
	}
}

# Subtract success chance and see if we should try again.
merc_stage4_failed = {
	merc_stage4_verify_operation_ongoing = yes

	subtract_variable = { which = "MercSuccess" value = 25 }
	if = { limit = { check_variable = { which = "MercSuccess" value > 90 } }
		random = { chance = 95 set_country_flag = "fmerc_retry_operation" }
	else = { if = { limit = { check_variable = { which = "MercSuccess" value > 80 } }
		random = { chance = 85 set_country_flag = "fmerc_retry_operation" }
	else = { if = { limit = { check_variable = { which = "MercSuccess" value > 70 } }
		random = { chance = 75 set_country_flag = "fmerc_retry_operation" }
	else = { if = { limit = { check_variable = { which = "MercSuccess" value > 60 } }
		random = { chance = 65 set_country_flag = "fmerc_retry_operation" }
	else = { if = { limit = { check_variable = { which = "MercSuccess" value > 50 } }
		random = { chance = 55 set_country_flag = "fmerc_retry_operation" }
	else = { if = { limit = { check_variable = { which = "MercSuccess" value > 40 } }
		random = { chance = 45 set_country_flag = "fmerc_retry_operation" }
	else = { if = { limit = { check_variable = { which = "MercSuccess" value > 30 } }
		random = { chance = 35 set_country_flag = "fmerc_retry_operation" }
	else = { if = { limit = { check_variable = { which = "MercSuccess" value > 20 } }
		random = { chance = 25 set_country_flag = "fmerc_retry_operation" }
	else = { if = { limit = { check_variable = { which = "MercSuccess" value > 10 } }
		random = { chance = 15 set_country_flag = "fmerc_retry_operation" }
	} } } } } } } } } } } } } } } } }

	if = {
		limit = { has_country_flag = "fmerc_retry_operation" }
		remove_country_flag = "fmerc_retry_operation"
		log = "Operation failed: Success chance was [this.MercSuccess]%, and the RNG was in our favor."
		merc_stage4_restart = yes

		else = {
			log = "Operation failed: Aborting due to low success factor ([this.MercSuccess])."
			merc_stage4_abort = yes
		}
	}
}

# Abruptly abort operation, regardless.
merc_stage4_abort = {
	merc_stage4_verify_operation_ongoing = yes
	log = "Forcefully aborting operations."

	# XXX actually, stop marking targets entirely and just use the kill
	# XXX counter + valid-triggers to find suitable targets.
	# XXX also check if there are any marked targets left?
	merc_stage4_complete = yes
}

# This is invoked by fleets when they think their operation might be complete
merc_stage4_maybe_complete = {
	merc_stage4_verify_operation_ongoing = yes

	if = { limit = { check_variable = { which = "MercTargetCount" value > 0.9 } }
		# We are not done, so find next target and get to it
		merc_stage4_restart = yes
	else = {
		merc_stage4_complete = yes
	} }
}

merc_stage4_restart = {
	merc_stage4_verify_operation_ongoing = yes
	log = "Restarting operations."

	merc_set_country = yes
	merc_set_buyer = yes

	remove_country_flag = "merc_found_target"
	event_target:merc_country = {
		if = { limit = { any_owned_planet = { has_planet_flag = "merc_target" } }
			random_owned_planet = {
				limit = { has_planet_flag = "merc_target" }
				PREVPREV = { set_country_flag = "merc_found_target" }
				save_event_target_as = merc_current_target
			}
			else = {
				if = { limit = { any_owned_ship = { exists = solar_system has_ship_flag = "merc_target" } }
					random_owned_ship = {
						limit = { has_ship_flag = "merc_target" }
						log = "Restart target: [this.GetName]"
						PREVPREV = { set_country_flag = "merc_found_target" }
						save_event_target_as = merc_current_target
					}
				}
			}
		}
	}

	if = { limit = { NOT = { has_country_flag = "merc_found_target" } }
		merc_stage2_mark_initial_targets = yes
	}

	merc_stage2_operation_start = yes
}
