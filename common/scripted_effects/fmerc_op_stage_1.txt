###
# This file is part of a project hosted at https://github.com/stellaris-mods
# Copyright (c) 2017 folk@folk.wtf
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software Foundation,
# Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301  USA
###


# STAGE 1
# - Initiated from the diplomacy screen
# - ROOT/THIS must be the buyer country for all stage1 effects
# - last_created_country is always the new mercenary operations country
#   created immediately in stage 1 init
# - fmerc_target_country is NOT guaranteed to exist

fmerc_stage1_copy_detection = {
	last_created_country = {
		set_variable = {
			which = "MercDetect"
			value = 0
		}
	}
	# ZZZ works because mercdetect is never above 100
	while = {
		limit = {
			check_variable = {
				which = "MercDetect"
				value > 0
			}
		}
		subtract_variable = {
			which = "MercDetect"
			value = 1
		}
		last_created_country = {
			change_variable = {
				which = "MercDetect"
				value = 1
			}
		}
	}
}

fmerc_stage1_copy_success = {
	last_created_country = {
		set_variable = {
			which = "MercSuccess"
			value = 0
		}
	}
	# ZZZ works because MercSuccess is never above 100
	while = {
		limit = {
			check_variable = {
				which = "MercSuccess"
				value > 0
			}
		}
		subtract_variable = {
			which = "MercSuccess"
			value = 1
		}
		last_created_country = {
			change_variable = {
				which = "MercSuccess"
				value = 1
			}
		}
	}
}

fmerc_stage1_culture_random = {
	last_created_country = {
		random_list = {
			1 = { set_country_flag = "arthropoid_01" }
			1 = { set_country_flag = "avian_01" }
			1 = { set_country_flag = "fungoid_01" }
			1 = { set_country_flag = "mammalian_01" }
			1 = { set_country_flag = "molluscoid_01" }
			1 = { set_country_flag = "plantoid_01" }
			1 = { set_country_flag = "reptilian_01" }
			1 = { set_country_flag = "ai_01" }
			1 = { set_country_flag = "extra_dimensional_01" }
			1 = { set_country_flag = "fallen_empire_01" }
			1 = { set_country_flag = "pirate_01" }
			1 = { set_country_flag = "swarm_01" }
			1 = { set_country_flag = "gfx_spacewhale" }
			1 = { set_country_flag = "gfx_cloud" }
			1 = { set_country_flag = "gfx_amoeba" }
			1 = { set_country_flag = "gfx_crystal" }
			1 = { set_country_flag = "gfx_drone" }
		}
	}
}

fmerc_stage1_culture_copy = {
	switch = {
		trigger = graphical_culture
		arthropoid_01 = { last_created_country = { set_country_flag = "arthropoid_01" } }
		avian_01 = { last_created_country = { set_country_flag = "avian_01" } }
		fungoid_01 = { last_created_country = { set_country_flag = "fungoid_01" } }
		mammalian_01 = { last_created_country = { set_country_flag = "mammalian_01" } }
		molluscoid_01 = { last_created_country = { set_country_flag = "molluscoid_01" } }
		plantoid_01 = { last_created_country = { set_country_flag = "plantoid_01" } }
		reptilian_01 = { last_created_country = { set_country_flag = "reptilian_01" } }
		ai_01 = { last_created_country = { set_country_flag = "ai_01" } }
		extra_dimensional_01 = { last_created_country = { set_country_flag = "extra_dimensional_01" } }
		extra_dimensional_02 = { last_created_country = { set_country_flag = "extra_dimensional_01" } }
		extra_dimensional_03 = { last_created_country = { set_country_flag = "extra_dimensional_01" } }
		fallen_empire_01 = { last_created_country = { set_country_flag = "fallen_empire_01" } }
		fallen_empire_02 = { last_created_country = { set_country_flag = "fallen_empire_01" } }
		fallen_empire_03 = { last_created_country = { set_country_flag = "fallen_empire_01" } }
		fallen_empire_04 = { last_created_country = { set_country_flag = "fallen_empire_01" } }
		fallen_machine_empire_01 = { last_created_country = { set_country_flag = "fallen_empire_01" } }
		pirate_01 = { last_created_country = { set_country_flag = "pirate_01" } }
		swarm_01 = { last_created_country = { set_country_flag = "swarm_01" } }
		ancient_drone_01 = { last_created_country = { set_country_flag = "gfx_drone" } }
		drone = { last_created_country = { set_country_flag = "gfx_drone" } }
		ancient = { last_created_country = { set_country_flag = "gfx_drone" } }
		techno = { last_created_country = { set_country_flag = "mammalian_01" } }
		# default trigger doesnt work for this one, but we fall back in the
		# has_country_flag selector anyway
	}
}

# scope is the buyer country
fmerc_stage1_setup_mission = {
	switch = {
		trigger = has_country_flag
		merc_disguise_random = {
			fmerc_stage1_culture_random = yes
		}
		# XXX add option to disguise as target. I should have thought of that
		# XXX a long time ago jeez
		merc_disguise_nonbuyer = {
			# Anything except ROOT
			# Set a random first
			fmerc_stage1_culture_random = yes

			# And then just verify that it's not the same
			# The reason we can't use a while loop is because repeated invokes
			# to random/random_list produces the same result.
			if = {
				limit = {
					switch = {
						trigger = graphical_culture
						arthropoid_01 = { last_created_country = { has_country_flag = "arthropoid_01" } }
						avian_01 = { last_created_country = { has_country_flag = "avian_01" } }
						fungoid_01 = { last_created_country = { has_country_flag = "fungoid_01" } }
						mammalian_01 = { last_created_country = { has_country_flag = "mammalian_01" } }
						molluscoid_01 = { last_created_country = { has_country_flag = "molluscoid_01" } }
						plantoid_01 = { last_created_country = { has_country_flag = "plantoid_01" } }
						reptilian_01 = { last_created_country = { has_country_flag = "reptilian_01" } }
						ai_01 = { last_created_country = { has_country_flag = "ai_01" } }
						extra_dimensional_01 = { last_created_country = { has_country_flag = "extra_dimensional_01" } }
						extra_dimensional_02 = { last_created_country = { has_country_flag = "extra_dimensional_01" } }
						extra_dimensional_03 = { last_created_country = { has_country_flag = "extra_dimensional_01" } }
						fallen_empire_01 = { last_created_country = { has_country_flag = "fallen_empire_01" } }
						fallen_empire_02 = { last_created_country = { has_country_flag = "fallen_empire_01" } }
						fallen_empire_03 = { last_created_country = { has_country_flag = "fallen_empire_01" } }
						fallen_empire_04 = { last_created_country = { has_country_flag = "fallen_empire_01" } }
						fallen_machine_empire_01 = { last_created_country = { has_country_flag = "fallen_empire_01" } }
						pirate_01 = { last_created_country = { has_country_flag = "pirate_01" } }
						swarm_01 = { last_created_country = { has_country_flag = "swarm_01" } }
						ancient_drone_01 = { last_created_country = { has_country_flag = "gfx_drone" } }
						drone = { last_created_country = { has_country_flag = "gfx_drone" } }
						ancient = { last_created_country = { has_country_flag = "gfx_drone" } }
						techno = { last_created_country = { has_country_flag = "mammalian_01" } }
					}
				}
				set_country_flag = "gfx_drone"
			}
		}
		merc_disguise_buyer = {
			# Same as ROOT
			fmerc_stage1_culture_copy = yes
		}
		merc_disguise_pirate = {
			last_created_country = {
				set_country_flag = "pirate_01"
			}
		}
		merc_disguise_xenofauna = {
			last_created_country = {
				random_list = {
					1 = { set_country_flag = "gfx_spacewhale" }
					1 = { set_country_flag = "gfx_cloud" }
					1 = { set_country_flag = "gfx_amoeba" }
					1 = { set_country_flag = "gfx_crystal" }
					1 = { set_country_flag = "gfx_drone" }
				}
			}
		}
	}
}

fmerc_stage1_setup_clear = {
	# The "clear space" missions do not set relation flag until stage 2.
	fmerc_stage1_culture_copy = yes
}

# THIS is the operations country
# event_target:mercenaries is the enclave
fmerc_stage1_determine_ship_powers = {
	# So, every time we create a new fmerc_operations country, their ship
	# designs are different, because of the DESIGNER_WEAPON_STACKING_DIV
	# and other defines. There could also be other reasons that I don't see.
	#
	# Anyway, the result is we need to spawn one of each ship to determine
	# how many ships we need to spawn later to match the target. And we need
	# to do this every time we create a new operations country.

	# Get a location to spawn in. This doesn't need to be safe, because our
	# fleets will be created and destroyed instantly, and never show ingame.
	event_target:mercenaries = {
		random_owned_fleet = { save_event_target_as = spawn }
	}
	# FROM here should be the merc enclave itself, and event_target:mercenaries

	# CORVETTE
	create_fleet = {
		effect = {
			set_owner = PREV
			set_location = event_target:spawn
			create_ship = { name = random random_existing_design = "corvette" }
		}
	}
	last_created_fleet = { merc_get_fleet_power = yes }
	set_variable = { which = "Corvette" value = "FleetPower" }
	set_variable = { which = "FleetPower" value = 0 }
	last_created_fleet = { delete_fleet = THIS }

	# DESTROYER
	create_fleet = {
		effect = {
			set_owner = PREV
			set_location = event_target:spawn
			create_ship = { name = random random_existing_design = "destroyer" }
		}
	}
	last_created_fleet = { merc_get_fleet_power = yes }
	set_variable = { which = "Destroyer" value = "FleetPower" }
	set_variable = { which = "FleetPower" value = 0 }
	last_created_fleet = { delete_fleet = THIS }

	# CRUISER
	create_fleet = {
		effect = {
			set_owner = PREV
			set_location = event_target:spawn
			create_ship = { name = random random_existing_design = "cruiser" }
		}
	}
	last_created_fleet = { merc_get_fleet_power = yes }
	set_variable = { which = "Cruiser" value = "FleetPower" }
	set_variable = { which = "FleetPower" value = 0 }
	last_created_fleet = { delete_fleet = THIS }

	# BATTLESHIP
	create_fleet = {
		effect = {
			set_owner = PREV
			set_location = event_target:spawn
			create_ship = { name = random random_existing_design = "battleship" }
		}
	}
	last_created_fleet = { merc_get_fleet_power = yes }
	set_variable = { which = "Battleship" value = "FleetPower" }
	set_variable = { which = "FleetPower" value = 0 }
	last_created_fleet = { delete_fleet = THIS }

	# Some of these might be zero, if there was no valid design.
	# In which case we won't use that type later.
	log = "OP Fleet Powers: C=[this.Corvette] D=[this.Destroyer] C=[this.Cruiser] B=[this.Battleship]."
}

fmerc_stage1_create_mercenaries = {
	create_country = {
		name = "Mercenary Operations"
		name_list = "FMercenaries"
		type = fmerc_operations
		species = ROOT.owner_species
		flag = { # Pirate flag copy from pirate_events
			icon = {
				category = "pirate"
				file = "flag_pirate_7.dds"
			}
			background = {
				category = "backgrounds"
				file = "00_solid.dds"
			}
			colors ={
				"red"
				"red"
				"null"
				"null"
			}
		}
		ethos = {
			ethic = ethic_militarist
			ethic = ethic_materialist
		}
		civics = {
			civic = civic_mercenary_operations
		}
		authority = auth_dictatorial
		auto_delete = no
		ignore_initial_colony_error = yes
		day_zero_contact = no
	}
	last_created_country = {
		establish_communications_no_message = ROOT
		establish_contact = { who = ROOT }
		establish_communications_no_message = event_target:mercenaries
		establish_contact = { who = event_target:mercenaries }

		# this makes it show in the contact list,
		# but at the same time it prevents the operations squad from engaging
		# the enclave
		set_subject_of = {
			who = event_target:mercenaries
			subject_type = mercsquad
		}
	}
}

# event_target:fmerc_target_country should be set before this
# but it might not be, in which case we just abort operation immediately
# Scope is the buyer country
fmerc_init_stage1 = {
	log = "Stage 1: Init Mercenary Operations"
	log = "Buyer is [Root.GetName]."

	fmerc_stage1_create_mercenaries = yes

	last_created_country = {
		copy_techs_from = {
			target = ROOT
			except = { tech_akx_worm_1 } # Errors without any
		}
		if = {
			limit = {
				exists = event_target:fmerc_target_country
				event_target:fmerc_target_country = { is_country_type = "default" }
			}
			copy_techs_from = {
				target = event_target:fmerc_target_country
				except = { tech_akx_worm_1 } # Errors without any
			}
		}
		# Just make sure we have access to all 4 vanilla ship types
		give_technology = { tech = tech_spaceport_1 message = no }
		give_technology = { tech = tech_spaceport_2 message = no }
		give_technology = { tech = tech_spaceport_3 message = no }
		give_technology = { tech = tech_spaceport_4 message = no }
		give_technology = { tech = tech_spaceport_5 message = no }
		give_technology = { tech = tech_spaceport_6 message = no }

		# We need this so that we have any drive with a higher priority
		# than WORMHOLE_DRIVE.
		give_technology = { tech = tech_warp_drive_1 message = no }
		give_technology = { tech = tech_warp_drive_2 message = no }

		# Hopefully this will force the ship designs to update, if they
		# haven't already.
		give_technology = { tech = tech_mercenary_enclave }

		fmerc_stage1_determine_ship_powers = yes

		# ZZZ Does not apply to created fleets for some reason
		set_policy = {
			policy = orbital_bombardment
			option = orbital_bombardment_full
			cooldown = no
		}

		# ZZZ 5-year operation time limit
		set_timed_country_flag = {
			flag = "fmerc_ops_timeout"
			days = 1800
		}

		set_relation_flag = {
			who = ROOT
			flag = merc_operations_squad
		}

		if = {
			# If this is a "clear space" operation, this might not be set
			# If it isn't, that means there are no countries of the selected
			# type with ships inside the buyers borders. Simply break,
			# and do nothing.
			limit = { exists = event_target:fmerc_target_country }
			set_relation_flag = {
				who = event_target:fmerc_target_country
				flag = merc_operations_target
			}
			event_target:fmerc_target_country = {
				set_country_flag = "fmerc_operations_target"
			}
		}
	}

	fmerc_stage1_copy_success = yes
	fmerc_stage1_copy_detection = yes

	switch = {
		trigger = has_country_flag
		merc_op_spaceport = {
			last_created_country = { set_country_flag = "merc_op_spaceport" }
			fmerc_stage1_setup_mission = yes
		}
		merc_op_liberation = {
			last_created_country = { set_country_flag = "merc_op_liberation" }
			fmerc_stage1_setup_mission = yes
		}
		merc_op_civilian = {
			last_created_country = { set_country_flag = "merc_op_civilian" }
			fmerc_stage1_setup_mission = yes
		}
		merc_op_fleet = {
			last_created_country = { set_country_flag = "merc_op_fleet" }
			fmerc_stage1_setup_mission = yes
		}
		merc_op_amoeba = {
			last_created_country = { set_country_flag = "merc_op_amoeba" }
			fmerc_stage1_setup_clear = yes
		}
		merc_op_cloud = {
			last_created_country = { set_country_flag = "merc_op_cloud" }
			fmerc_stage1_setup_clear = yes
		}
		merc_op_crystal = {
			last_created_country = { set_country_flag = "merc_op_crystal" }
			fmerc_stage1_setup_clear = yes
		}
		merc_op_pirate = {
			last_created_country = { set_country_flag = "merc_op_pirate" }
			fmerc_stage1_setup_clear = yes
		}
		merc_op_drone = {
			last_created_country = { set_country_flag = "merc_op_drone" }
			fmerc_stage1_setup_clear = yes
		}
	}

	last_created_country = {
		switch = {
			trigger = has_country_flag
			gfx_spacewhale = { set_graphical_culture = merc_whale }
			gfx_crystal = { set_graphical_culture = merc_crystal }
			gfx_cloud = { set_graphical_culture = merc_cloud }
			gfx_amoeba = { set_graphical_culture = merc_amoeba }
			gfx_drone = { set_graphical_culture = merc_drone }
			fallen_empire_01 = { set_graphical_culture = merc_fallen }
			ai_01 = { set_graphical_culture = merc_ai }
			swarm_01 = { set_graphical_culture = merc_swarm }
			extra_dimensional_01 = { set_graphical_culture = merc_ed }
			pirate_01 = { set_graphical_culture = merc_pirate }
			arthropoid_01 = { set_graphical_culture = arthropoid_01 }
			avian_01 = { set_graphical_culture = avian_01 }
			fungoid_01 = { set_graphical_culture = fungoid_01 }
			mammalian_01 = { set_graphical_culture = mammalian_01 }
			molluscoid_01 = { set_graphical_culture = molluscoid_01 }
			plantoid_01 = { set_graphical_culture = plantoid_01 }
			reptilian_01 = { set_graphical_culture = reptilian_01 }
			default = {
				# XXX set a random one
				set_graphical_culture = mammalian_01
			}
		}

		switch = {
			trigger = has_country_flag
			merc_op_amoeba = { country_event = { id = mercOpsMeta.1 } }
			merc_op_cloud = { country_event = { id = mercOpsMeta.1 } }
			merc_op_crystal = { country_event = { id = mercOpsMeta.1 } }
			merc_op_pirate = { country_event = { id = mercOpsMeta.1 } }
			merc_op_drone = { country_event = { id = mercOpsMeta.1 } }
			merc_op_spaceport = {
				country_event = {
					id = mercOpsMeta.1
					days = 3
					random = 70
				}
			}
			merc_op_liberation = {
				country_event = {
					id = mercOpsMeta.1
					days = 3
					random = 70
				}
			}
			merc_op_civilian = {
				country_event = {
					id = mercOpsMeta.1
					days = 3
					random = 70
				}
			}
			merc_op_fleet = {
				country_event = {
					id = mercOpsMeta.1
					days = 3
					random = 70
				}
			}
			default = {
				country_event = {
					id = mercOpsMeta.1
					days = 3
					random = 70
				}
			}
		}
	}
}
