###
# This file is part of a project hosted at https://github.com/stellaris-mods
# Copyright (c) 2017 folk@folk.wtf
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software Foundation,
# Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301  USA
###


# STAGE 1
# - Initiated from the diplomacy screen
# - ROOT/THIS must be the buyer country for all stage1 effects
# - last_created_country is always the new mercenary operations country
#   created immediately in stage 1 init
# - fmerc_target_country is NOT guaranteed to exist

fmerc_stage1_copy_detection = {
	last_created_country = {
		set_variable = {
			which = MercDetect
			value = 0
		}
	}
	# ZZZ works because mercdetect is never above 100
	while = {
		limit = {
			check_variable = {
				which = MercDetect
				value > 0
			}
		}
		subtract_variable = {
			which = MercDetect
			value = 1
		}
		last_created_country = {
			change_variable = {
				which = MercDetect
				value = 1
			}
		}
	}
}

fmerc_stage1_copy_success = {
	last_created_country = {
		set_variable = {
			which = MercSuccess
			value = 0
		}
	}
	# ZZZ works because MercSuccess is never above 100
	while = {
		limit = {
			check_variable = {
				which = MercSuccess
				value > 0
			}
		}
		subtract_variable = {
			which = MercSuccess
			value = 1
		}
		last_created_country = {
			change_variable = {
				which = MercSuccess
				value = 1
			}
		}
	}
}

fmerc_stage1_culture_random = {
	last_created_country = {
		random_list = {
			14 = { set_country_flag = "arthropoid_01" }
			14 = { set_country_flag = "avian_01" }
			14 = { set_country_flag = "fungoid_01" }
			16 = {
				# Guess I didn't know back then that
				# random_list was N-in-X, not N-in-100
				set_country_flag = "mammalian_01"
			}
			14 = { set_country_flag = "molluscoid_01" }
			14 = { set_country_flag = "plantoid_01" }
			14 = { set_country_flag = "reptilian_01" }
		}
	}
}

fmerc_stage1_culture_copy = {
	switch = {
		trigger = graphical_culture
		arthropoid_01 = {
			last_created_country = {
				set_country_flag = "arthropoid_01"
			}
		}
		avian_01 = {
			last_created_country = {
				set_country_flag = "avian_01"
			}
		}
		fungoid_01 = {
			last_created_country = {
				set_country_flag = "fungoid_01"
			}
		}
		mammalian_01 = {
			last_created_country = {
				set_country_flag = "mammalian_01"
			}
		}
		molluscoid_01 = {
			last_created_country = {
				set_country_flag = "molluscoid_01"
			}
		}
		plantoid_01 = {
			last_created_country = {
				set_country_flag = "plantoid_01"
			}
		}
		reptilian_01 = {
			last_created_country = {
				set_country_flag = "reptilian_01"
			}
		}
		ai_01 = {
			last_created_country = {
				set_country_flag = "ai_01"
			}
		}
		extra_dimensional_01 = {
			last_created_country = {
				set_country_flag = "extra_dimensional_01"
			}
		}
		extra_dimensional_02 = {
			last_created_country = {
				set_country_flag = "extra_dimensional_01"
			}
		}
		extra_dimensional_03 = {
			last_created_country = {
				set_country_flag = "extra_dimensional_01"
			}
		}
		fallen_empire_01 = {
			last_created_country = {
				set_country_flag = "fallen_empire_01"
			}
		}
		fallen_empire_02 = {
			last_created_country = {
				set_country_flag = "fallen_empire_01"
			}
		}
		fallen_empire_03 = {
			last_created_country = {
				set_country_flag = "fallen_empire_01"
			}
		}
		fallen_empire_04 = {
			last_created_country = {
				set_country_flag = "fallen_empire_01"
			}
		}
		fallen_machine_empire_01 = {
			last_created_country = {
				set_country_flag = "fallen_empire_01"
			}
		}
		pirate_01 = {
			last_created_country = {
				set_country_flag = "pirate_01"
			}
		}
		swarm_01 = {
			last_created_country = {
				set_country_flag = "swarm_01"
			}
		}
		ancient_drone_01 = {
			last_created_country = {
				set_country_flag = "gfx_drone"
			}
		}
		drone = {
			last_created_country = {
				set_country_flag = "gfx_drone"
			}
		}
		ancient = {
			last_created_country = {
				set_country_flag = "gfx_drone"
			}
		}
		techno = {
			last_created_country = {
				set_country_flag = "mammalian_01"
			}
		}
		# default trigger doesnt work for this one
		# default = {
		# 	last_created_country = {
		# 		set_graphical_culture = "mammalian_01"
		# 	}
		# }
	}
}

# scope is the buyer country
fmerc_stage1_setup_mission = {
	switch = {
		trigger = has_country_flag
		fmerc_diplo_disguise_random = {
			fmerc_stage1_culture_random = yes
		}
		fmerc_diplo_disguise_other = {
			# Anything except ROOT
			fmerc_stage1_culture_random = yes
			if = {
				limit = {
					fmerc_stage1_same_culture = yes
				}
				set_country_flag = "gfx_drone"
			}
		}
		fmerc_diplo_disguise_same = {
			# Same as ROOT
			fmerc_stage1_culture_copy = yes
		}
		fmerc_diplo_disguise_pirate = {
			last_created_country = {
				set_country_flag = "pirate_01"
			}
		}
		fmerc_diplo_disguise_monster = {
			last_created_country = {
				random_list = { # yaya could use 1 1 1 1 1
					20 = { set_country_flag = "gfx_spacewhale" }
					20 = { set_country_flag = "gfx_cloud" }
					20 = { set_country_flag = "gfx_amoeba" }
					20 = { set_country_flag = "gfx_crystal" }
					20 = { set_country_flag = "gfx_drone" }
				}
			}
		}
	}
}

fmerc_stage1_setup_clear = {
	# The "clear space" missions do not set relation flag until stage 2.
	fmerc_stage1_culture_copy = yes
}

# event_target:fmerc_target_country should be set before this
# Scope is the buyer country
fmerc_init_stage1 = {
	log = "Stage 1: Init Mercenary Operations"
	log = "Buyer is [Root.GetName]."
	create_country = {
		name = "Mercenary Operations"
		name_list = "FMercenaries"
		type = fmerc_operations
		species = random
		flag = { # Pirate flag copy
			icon = {
				category = "zoological"
				file = "flag_zoological_1.dds"
			}
			background = {
				category = "backgrounds"
				file = "00_solid.dds"
			}
			colors = {
				"black"
				"black"
				"null"
				"null"
			}
		}
		ethos = {
			ethic = ethic_militarist
			ethic = ethic_materialist
		}
		civics = random
		authority = auth_dictatorial
		auto_delete = no
	}
	last_created_country = {
		establish_communications_no_message = ROOT
		establish_contact = { who = ROOT }
		establish_communications_no_message = event_target:traders
		establish_contact = { who = event_target:traders }

		# This isn't actually needed, so not sure why I dont just remove it.
		give_technology = {
			tech = tech_mercenary_enclave
			message = no
		}
		give_technology = {
			tech = tech_jump_drive_1
			message = no
		}

		# ZZZ Does not apply to created fleets for some reason
		set_policy = {
			policy = orbital_bombardment
			option = orbital_bombardment_full
			cooldown = no
		}

		# ZZZ 5-year operation time limit
		set_timed_country_flag = {
			flag = "fmerc_ops_timeout"
			days = 1800
		}

		# this makes it show in the contact list,
		# but at the same time it prevents the operations squad from engaging
		# the enclave
		set_subject_of = {
			who = event_target:traders
			subject_type = mercsquad
		}

		set_relation_flag = {
			who = ROOT
			flag = merc_operations_squad
		}

		if = {
			# If this is a "clear space" operation, this might not be set
			# If it isn't, that means there are no countries of the selected
			# type with ships inside the buyers borders. Simply break,
			# and do nothing.
			limit = { exists = event_target:fmerc_target_country }
			set_relation_flag = {
				who = event_target:fmerc_target_country
				flag = merc_operations_target
			}
			event_target:fmerc_target_country = {
				set_country_flag = "fmerc_operations_target"
			}
		}
	}

	fmerc_stage1_copy_success = yes
	fmerc_stage1_copy_detection = yes

	switch = {
		trigger = has_country_flag
		fmerc_diplo_spaceport = {
			last_created_country = {
				set_country_flag = "fmerc_spaceport"
			}
			fmerc_stage1_setup_mission = yes
		}
		fmerc_diplo_liberate = {
			last_created_country = {
				set_country_flag = "fmerc_liberate"
			}
			fmerc_stage1_setup_mission = yes
		}
		fmerc_diplo_miningraid = {
			last_created_country = {
				set_country_flag = "fmerc_raid"
			}
			fmerc_stage1_setup_mission = yes
		}
		fmerc_diplo_fleetraid = {
			last_created_country = {
				set_country_flag = "fmerc_fleet"
			}
			fmerc_stage1_setup_mission = yes
		}
		fmerc_target_amoeba = {
			last_created_country = {
				set_country_flag = "fmerc_amoeba"
			}
			fmerc_stage1_setup_clear = yes
		}
		fmerc_target_cloud = {
			last_created_country = {
				set_country_flag = "fmerc_cloud"
			}
			fmerc_stage1_setup_clear = yes
		}
		fmerc_target_crystal = {
			last_created_country = {
				set_country_flag = "fmerc_crystal"
			}
			fmerc_stage1_setup_clear = yes
		}
		fmerc_target_pirate = {
			last_created_country = {
				set_country_flag = "fmerc_pirate"
			}
			fmerc_stage1_setup_clear = yes
		}
		fmerc_target_drone = {
			last_created_country = {
				set_country_flag = "fmerc_drone"
			}
			fmerc_stage1_setup_clear = yes
		}
	}

	last_created_country = {
		switch = {
			trigger = has_country_flag
			gfx_spacewhale = { set_graphical_culture = merc_whale }
			gfx_crystal = { set_graphical_culture = merc_crystal }
			gfx_cloud = { set_graphical_culture = merc_cloud }
			gfx_amoeba = { set_graphical_culture = merc_amoeba }
			gfx_drone = { set_graphical_culture = merc_drone }
			fallen_empire_01 = { set_graphical_culture = merc_fallen }
			ai_01 = { set_graphical_culture = merc_ai }
			swarm_01 = { set_graphical_culture = merc_swarm }
			extra_dimensional_01 = { set_graphical_culture = merc_ed }
			pirate_01 = { set_graphical_culture = merc_pirate }
			arthropoid_01 = { set_graphical_culture = arthropoid_01 }
			avian_01 = { set_graphical_culture = avian_01 }
			fungoid_01 = { set_graphical_culture = fungoid_01 }
			mammalian_01 = { set_graphical_culture = mammalian_01 }
			molluscoid_01 = { set_graphical_culture = molluscoid_01 }
			plantoid_01 = { set_graphical_culture = plantoid_01 }
			reptilian_01 = { set_graphical_culture = reptilian_01 }
			default = {
				set_graphical_culture = mammalian_01
			}
		}

		switch = {
			trigger = has_country_flag
			fmerc_amoeba = { country_event = { id = fmerc_ops_meta.1 } }
			fmerc_cloud = { country_event = { id = fmerc_ops_meta.1 } }
			fmerc_crystal = { country_event = { id = fmerc_ops_meta.1 } }
			fmerc_pirate = { country_event = { id = fmerc_ops_meta.1 } }
			fmerc_drone = { country_event = { id = fmerc_ops_meta.1 } }
			fmerc_spaceport = {
				country_event = {
					id = fmerc_ops_meta.1
					days = 3
					random = 70
				}
			}
			fmerc_liberate = {
				country_event = {
					id = fmerc_ops_meta.1
					days = 3
					random = 70
				}
			}
			fmerc_raid = {
				country_event = {
					id = fmerc_ops_meta.1
					days = 3
					random = 70
				}
			}
			fmerc_fleet = {
				country_event = {
					id = fmerc_ops_meta.1
					days = 3
					random = 70
				}
			}
			default = {
				country_event = {
					id = fmerc_ops_meta.1
					days = 3
					random = 70
				}
			}
		}
	}
}
