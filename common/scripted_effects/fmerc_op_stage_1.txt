
fmerc_stage1_copy_detection = {
	last_created_country = {
		set_variable = {
			which = MercDetect
			value = 0
		}
	}
	# ZZZ works because mercdetect is never above 100
	while = {
		limit = {
			check_variable = {
				which = MercDetect
				value > 0
			}
		}
		subtract_variable = {
			which = MercDetect
			value = 1
		}
		last_created_country = {
			change_variable = {
				which = MercDetect
				value = 1
			}
		}
	}
}

fmerc_stage1_copy_success = {
	last_created_country = {
		set_variable = {
			which = MercSuccess
			value = 0
		}
	}
	# ZZZ works because MercSuccess is never above 100
	while = {
		limit = {
			check_variable = {
				which = MercSuccess
				value > 0
			}
		}
		subtract_variable = {
			which = MercSuccess
			value = 1
		}
		last_created_country = {
			change_variable = {
				which = MercSuccess
				value = 1
			}
		}
	}
}

fmerc_stage1_culture_random = {
	last_created_country = {
		random_list = {
			14 = { set_country_flag = "arthropoid_01" }
			14 = { set_country_flag = "avian_01" }
			14 = { set_country_flag = "fungoid_01" }
			16 = {
				# Guess I didn't know back then that
				# random_list was N-in-X, not N-in-100
				set_country_flag = "mammalian_01"
			}
			14 = { set_country_flag = "molluscoid_01" }
			14 = { set_country_flag = "plantoid_01" }
			14 = { set_country_flag = "reptilian_01" }
		}
	}
}

fmerc_stage1_culture_copy = {
	switch = {
		trigger = graphical_culture
		arthropoid_01 = {
			last_created_country = {
				set_country_flag = "arthropoid_01"
			}
		}
		avian_01 = {
			last_created_country = {
				set_country_flag = "avian_01"
			}
		}
		fungoid_01 = {
			last_created_country = {
				set_country_flag = "fungoid_01"
			}
		}
		mammalian_01 = {
			last_created_country = {
				set_country_flag = "mammalian_01"
			}
		}
		molluscoid_01 = {
			last_created_country = {
				set_country_flag = "molluscoid_01"
			}
		}
		plantoid_01 = {
			last_created_country = {
				set_country_flag = "plantoid_01"
			}
		}
		reptilian_01 = {
			last_created_country = {
				set_country_flag = "reptilian_01"
			}
		}
		ai_01 = {
			last_created_country = {
				set_country_flag = "ai_01"
			}
		}
		extra_dimensional_01 = {
			last_created_country = {
				set_country_flag = "extra_dimensional_01"
			}
		}
		extra_dimensional_02 = {
			last_created_country = {
				set_country_flag = "extra_dimensional_01"
			}
		}
		extra_dimensional_03 = {
			last_created_country = {
				set_country_flag = "extra_dimensional_01"
			}
		}
		fallen_empire_01 = {
			last_created_country = {
				set_country_flag = "fallen_empire_01"
			}
		}
		fallen_empire_02 = {
			last_created_country = {
				set_country_flag = "fallen_empire_01"
			}
		}
		fallen_empire_03 = {
			last_created_country = {
				set_country_flag = "fallen_empire_01"
			}
		}
		fallen_empire_04 = {
			last_created_country = {
				set_country_flag = "fallen_empire_01"
			}
		}
		fallen_machine_empire_01 = {
			last_created_country = {
				set_country_flag = "fallen_empire_01"
			}
		}
		pirate_01 = {
			last_created_country = {
				set_country_flag = "pirate_01"
			}
		}
		swarm_01 = {
			last_created_country = {
				set_country_flag = "swarm_01"
			}
		}
		ancient_drone_01 = {
			last_created_country = {
				set_country_flag = "gfx_drone"
			}
		}
		drone = {
			last_created_country = {
				set_country_flag = "gfx_drone"
			}
		}
		ancient = {
			last_created_country = {
				set_country_flag = "gfx_drone"
			}
		}
		techno = {
			last_created_country = {
				set_country_flag = "mammalian_01"
			}
		}
		# default trigger doesnt work for this one
		# default = {
		# 	last_created_country = {
		# 		set_graphical_culture = "mammalian_01"
		# 	}
		# }
	}
}

# scope is the buyer country
fmerc_stage1_setup_mission = {
	# Set relation flag here for standard mission types,
	# because we get event_target:fmerc_target_country from
	# the diplomatic screen. The "clear space" missions
	# do not set this relation flag until stage 2.
	last_created_country = {
		set_relation_flag = {
			who = event_target:fmerc_target_country
			flag = merc_operations_target
		}
	}
	switch = {
		trigger = has_country_flag
		fmerc_diplo_disguise_random = {
			fmerc_stage1_culture_random = yes
		}
		fmerc_diplo_disguise_other = {
			# Anything except root
			fmerc_stage1_culture_random = yes
			if = {
				limit = {
					fmerc_stage1_same_culture = yes
				}
				set_country_flag = "gfx_drone"
			}
		}
		fmerc_diplo_disguise_same = {
			# Same as root
			fmerc_stage1_culture_copy = yes
		}
		fmerc_diplo_disguise_pirate = {
			last_created_country = {
				set_country_flag = "pirate_01"
			}
		}
		fmerc_diplo_disguise_monster = {
			last_created_country = {
				random_list = { # yaya could use 1 1 1 1 1
					20 = { set_country_flag = "gfx_spacewhale" }
					20 = { set_country_flag = "gfx_cloud" }
					20 = { set_country_flag = "gfx_amoeba" }
					20 = { set_country_flag = "gfx_crystal" }
					20 = { set_country_flag = "gfx_drone" }
				}
			}
		}
	}
}

fmerc_stage1_setup_clear = {
	# The "clear space" missions do not set relation flag until stage 2.
	fmerc_stage1_culture_copy = yes
}

# Simple rule of thumb: any scripted effect that has "init"
# in it must exclusively flow from this.
# Scope is the buyer country
fmerc_init_stage1 = {
	create_country = {
		name = "Mercenary Operations"
		name_list = "FMercenaries"
		type = fmerc_operations
		species = random
		flag = { # Pirate flag copy
			icon = {
				category = "zoological"
				file = "flag_zoological_1.dds"
			}
			background = {
				category = "backgrounds"
				file = "00_solid.dds"
			}
			colors = {
				"black"
				"black"
				"null"
				"null"
			}
		}
		ethos = {
			ethic = ethic_militarist
			ethic = ethic_materialist
		}
		civics = random
		authority = auth_dictatorial
		auto_delete = no
	}
	last_created_country = {
		#establish_communications_no_message = root
		#establish_contact = { who = root }
		#establish_communications_no_message = event_target:traders
		#establish_contact = { who = event_target:traders }
		#establish_communications_no_message = event_target:fmerc_target_country

		# This isn't actually needed, so not sure why I dont just remove it.
		give_technology = {
			tech = tech_mercenary_enclave
			message = no
		}
		give_technology = {
			tech = tech_jump_drive_1
			message = no
		}

		# XXX Does not apply to created fleets for some reason
		set_policy = {
			policy = orbital_bombardment
			option = orbital_bombardment_full
			cooldown = no
		}

		# ZZZ 5-year operation time limit
		set_timed_country_flag = {
			flag = fmerc_ops_timeout
			days = 1800
		}

		# this makes it show in the contact list,
		# but at the same time it prevents the operations squad from engaging
		# the enclave
		set_subject_of = {
			who = event_target:traders
			subject_type = mercsquad
		}

		set_relation_flag = {
			who = ROOT
			flag = merc_operations_squad
		}
	}

	fmerc_stage1_copy_success = yes
	fmerc_stage1_copy_detection = yes

	switch = {
		trigger = has_country_flag
		fmerc_diplo_spaceport = {
			last_created_country = {
				set_country_flag = "fmerc_spaceport"
			}
			fmerc_stage1_setup_mission = yes
		}
		fmerc_diplo_liberate = {
			last_created_country = {
				set_country_flag = "fmerc_liberate"
			}
			fmerc_stage1_setup_mission = yes
		}
		fmerc_diplo_miningraid = {
			last_created_country = {
				set_country_flag = "fmerc_raid"
			}
			fmerc_stage1_setup_mission = yes
		}
		fmerc_diplo_fleetraid = {
			last_created_country = {
				set_country_flag = "fmerc_fleet"
			}
			fmerc_stage1_setup_mission = yes
		}
		fmerc_target_amoeba = {
			last_created_country = {
				set_country_flag = "fmerc_amoeba"
			}
			fmerc_stage1_setup_clear = yes
		}
		fmerc_target_cloud = {
			last_created_country = {
				set_country_flag = "fmerc_cloud"
			}
			fmerc_stage1_setup_clear = yes
		}
		fmerc_target_crystal = {
			last_created_country = {
				set_country_flag = "fmerc_crystal"
			}
			fmerc_stage1_setup_clear = yes
		}
		fmerc_target_pirate = {
			last_created_country = {
				set_country_flag = "fmerc_pirate"
			}
			fmerc_stage1_setup_clear = yes
		}
		fmerc_target_drone = {
			last_created_country = {
				set_country_flag = "fmerc_drone"
			}
			fmerc_stage1_setup_clear = yes
		}
	}

	last_created_country = {
		switch = {
			trigger = has_country_flag
			gfx_spacewhale = { create_ship_design = { design = "2FBY-31" } }
			gfx_crystal = { create_ship_design = { design = "E-BMBU4" } }
			gfx_cloud = { create_ship_design = { design = "UW-FS6J" } }
			gfx_amoeba = { create_ship_design = { design = "NQ-SGTV" } }
			arthropoid_01 = { create_ship_design = { design = "DTLS1-M" } }
			avian_01 = { create_ship_design = { design = "RM8UT-9" } }
			fungoid_01 = { create_ship_design = { design = "UJ0BO-1" } }
			mammalian_01 = { create_ship_design = { design = "JK3XO-U" } }
			molluscoid_01 = { create_ship_design = { design = "4EJVS-8" } }
			plantoid_01 = { create_ship_design = { design = "D1NU-F7" } }
			reptilian_01 = { create_ship_design = { design = "H4-9O58" } }
			fallen_empire_01 = { create_ship_design = { design = "F49WQ-2" } }
			pirate_01 = { create_ship_design = { design = "W3I-X2Y" } }
			ai_01 = { create_ship_design = { design = "UR-IVS5" } }
			swarm_01 = { create_ship_design = { design = "K7FXX-L"} }
			extra_dimensional_01 = { create_ship_design = { design = "CF-X86W"} }
			# Keep gfx_drone last since we use it as fallback in fmerc_stage1_setup_mission
			# Does that make sense? Maybe it should be first in the switch. I dont know if it
			# stops at first hit or continues.
			gfx_drone = { create_ship_design = { design = "B370-NF" } }
			default = {
				# Confirmed this does trigger if none of the above
				create_ship_design = { design = "W3I-X2Y" }
			}
		}
		add_ship_design = last_created_design

		switch = {
			trigger = has_country_flag
			fmerc_amoeba = { country_event = { id = fmerc_ops_meta.1 } }
			fmerc_cloud = { country_event = { id = fmerc_ops_meta.1 } }
			fmerc_crystal = { country_event = { id = fmerc_ops_meta.1 } }
			fmerc_pirate = { country_event = { id = fmerc_ops_meta.1 } }
			fmerc_drone = { country_event = { id = fmerc_ops_meta.1 } }
			fmerc_spaceport = {
				country_event = {
					id = fmerc_ops_meta.1
					days = 3
					random = 70
				}
			}
			fmerc_liberate = {
				country_event = {
					id = fmerc_ops_meta.1
					days = 3
					random = 70
				}
			}
			fmerc_raid = {
				country_event = {
					id = fmerc_ops_meta.1
					days = 3
					random = 70
				}
			}
			fmerc_fleet = {
				country_event = {
					id = fmerc_ops_meta.1
					days = 3
					random = 70
				}
			}
			default = {
				country_event = {
					id = fmerc_ops_meta.1
					days = 3
					random = 70
				}
			}
		}
	}
}
