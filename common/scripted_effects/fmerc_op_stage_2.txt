
# This is delayed
# stage 2 is in the operations country scope
fmerc_init_stage2 = {
	fmerc_set_buyer = yes
	fmerc_set_target_country = yes
	if = {
		limit = {
			exists = event_target:fmerc_buyer
			exists = event_target:fmerc_target_country
			fmerc_enclave_exists = yes
		}
		# We found the buyer, and an enclave exists
		switch = {
			trigger = has_country_flag
			fmerc_spaceport = {
				fmerc_stage2_init_spaceport = yes
				fmerc_stage2_tag_ships = yes
				country_event = { id = fmerc_ops_fleet.1 }
			}
			fmerc_liberate = {
				fmerc_stage2_init_liberation = yes
				country_event = { id = fmerc_ops_liberate.1 }
			}
			fmerc_raid = {
				# Ships are tagged in this
				fmerc_stage2_init_raid = yes
				country_event = { id = fmerc_ops_fleet.1 }
			}
			fmerc_fleet = {
				fmerc_stage2_init_fleet = yes
				fmerc_stage2_tag_ships = yes
				country_event = { id = fmerc_ops_fleet.1 }
			}
			fmerc_amoeba = {
				fmerc_stage2_init_clear = yes
				fmerc_stage2_tag_ships = yes
				country_event = { id = fmerc_ops_fleet.1 }
			}
			fmerc_cloud = {
				fmerc_stage2_init_clear = yes
				fmerc_stage2_tag_ships = yes
				country_event = { id = fmerc_ops_fleet.1 }
			}
			fmerc_crystal = {
				fmerc_stage2_init_clear = yes
				fmerc_stage2_tag_ships = yes
				country_event = { id = fmerc_ops_fleet.1 }
			}
			fmerc_pirate = {
				fmerc_stage2_init_clear = yes
				fmerc_stage2_tag_ships = yes
				country_event = { id = fmerc_ops_fleet.1 }
			}
			fmerc_drone = {
				fmerc_stage2_init_clear = yes
				fmerc_stage2_tag_ships = yes
				country_event = { id = fmerc_ops_fleet.1 }
			}
		}

		# Either the buyer country is gone, or there are
		# no mercenary enclaves left.
		else = {
			set_country_flag = "fmerc_ops_completed"
		}
	}
}

fmerc_stage2_tag_ships = {
	if = {
		limit = {
			# ZZZ
			# fmerc_target doesnt exist if we're doing a space clear event,
			# and there are zero creatures to attack
			exists = event_target:fmerc_target
		}
		event_target:fmerc_target_country = {
			every_owned_ship = {
				limit = {
					exists = fleet
					fleet = {
						is_same_value = event_target:fmerc_target
					}
				}
				set_ship_flag = "fmerc_target"
			}
		}
		else = { # No target exists, so simply GTFO
			set_country_flag = "fmerc_ops_completed"
		}
	}
}
